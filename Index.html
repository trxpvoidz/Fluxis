<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AES-256-CFB-8 Encryption Demo</title>
<style>
  body { font-family: monospace; background: #222; color: #eee; padding: 1rem; }
  #dropzone {
    border: 2px dashed #555; padding: 3rem; margin: 1rem 0;
    text-align: center; cursor: pointer; color: #999;
  }
  #dropzone.hover { border-color: #0f0; color: #afa; }
  #log { white-space: pre-wrap; background: #111; padding: 1rem; height: 200px; overflow-y: auto; margin-top: 1rem; }
</style>
</head>
<body>

<h1>AES-256-CFB-8 Encryptor</h1>

<div id="dropzone">Drop files here or click to select</div>
<input type="file" id="fileinput" multiple style="display:none" />

<button id="encryptBtn">Encrypt Selected</button>

<div id="log"></div>

<script>
const dropzone = document.getElementById('dropzone');
const fileinput = document.getElementById('fileinput');
const encryptBtn = document.getElementById('encryptBtn');
const logEl = document.getElementById('log');

let files = [];

function log(msg) {
  logEl.textContent += msg + '\n';
  logEl.scrollTop = logEl.scrollHeight;
}

dropzone.addEventListener('dragover', e => {
  e.preventDefault();
  dropzone.classList.add('hover');
});
dropzone.addEventListener('dragleave', e => {
  dropzone.classList.remove('hover');
});
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('hover');
  files = [...e.dataTransfer.files];
  log(`Loaded ${files.length} file(s)`);
});

dropzone.addEventListener('click', () => {
  fileinput.click();
});
fileinput.addEventListener('change', () => {
  files = [...fileinput.files];
  log(`Selected ${files.length} file(s)`);
});

async function importKey(rawKey) {
  return crypto.subtle.importKey(
    'raw',
    rawKey,
    { name: 'AES-ECB', length: 256 },
    false,
    ['encrypt']
  );
}

async function aes256Cfb8Encrypt(keyBytes, ivBytes, plaintextBytes) {
  const cryptoKey = await importKey(keyBytes);
  const blockSize = 16;
  let shiftRegister = new Uint8Array(ivBytes);
  const ciphertext = new Uint8Array(plaintextBytes.length);

  for (let i = 0; i < plaintextBytes.length; i++) {
    const encryptedBlockBuffer = await crypto.subtle.encrypt(
      { name: 'AES-ECB' },
      cryptoKey,
      shiftRegister
    );
    const encryptedBlock = new Uint8Array(encryptedBlockBuffer);

    const cipherByte = plaintextBytes[i] ^ encryptedBlock[0];
    ciphertext[i] = cipherByte;

    shiftRegister.copyWithin(0, 1);
    shiftRegister[blockSize - 1] = cipherByte;

    if (i % 1024 === 0) log(`Encrypting: ${((i / plaintextBytes.length) * 100).toFixed(2)}%`);
  }
  log('Encryption complete.');
  return ciphertext;
}

async function processFiles() {
  if (files.length === 0) {
    log('No files selected!');
    return;
  }

  // Example key and IV (replace with your actual key/IV)
  const keyStr = 's5s5ejuDru4uchuF2drUFuthaspAbepE';
  const keyBytes = new TextEncoder().encode(keyStr);
  const ivBytes = keyBytes.slice(0, 16);

  for (const file of files) {
    log(`Reading file: ${file.name}`);

    const arrayBuffer = await file.arrayBuffer();
    const plaintextBytes = new Uint8Array(arrayBuffer);

    log(`Encrypting file: ${file.name}`);
    const ciphertext = await aes256Cfb8Encrypt(keyBytes, ivBytes, plaintextBytes);

    // Create Blob and download
    const blob = new Blob([ciphertext], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = file.name + '.enc';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    log(`Encrypted and downloaded: ${file.name}.enc`);
  }
}

encryptBtn.addEventListener('click', () => {
  processFiles().catch(e => log('Error: ' + e));
});

</script>

</body>
</html>
