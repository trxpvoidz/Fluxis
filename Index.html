<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fluxis Encryption Tool</title>
  <style>
    body {
      background: linear-gradient(to bottom right, #111, #1a1a1a);
      color: white;
      font-family: monospace;
      text-align: center;
      padding: 20px;
    }

    .drop-zone {
      border: 2px dashed #aaa;
      padding: 30px;
      margin: 20px;
      cursor: pointer;
    }

    .drop-zone:hover {
      background: #222;
    }

    #log {
      background: #000;
      color: #0f0;
      text-align: left;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      border: 1px solid #444;
    }

    #progress {
      width: 100%;
      background-color: #333;
      height: 20px;
      margin-top: 10px;
    }

    #bar {
      height: 100%;
      background-color: lime;
      width: 0%;
    }

    @media (max-width: 600px) {
      .drop-zone {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <h1>Fluxis Pack Encrypter</h1>
  <div class="drop-zone" onclick="triggerFile()">
    Click or Drop Minecraft Skin Pack Folder Here
    <input type="file" id="input" webkitdirectory directory multiple hidden onchange="handleFiles(this.files)" />
  </div>

  <div id="progress">
    <div id="bar"></div>
  </div>

  <pre id="log">[~] Waiting for files...</pre>

  <script>
    const keyHex = '73357335656a7544727534756368754632647255467574686173704162657045';
    const ivHex = '73357335656a7544727534756368';
    const exclusions = ['manifest.json', 'pack_icon.png'];

    function log(msg, path = '') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.textContent = msg;
      if (path) {
        entry.style.cursor = 'pointer';
        entry.onclick = () => alert('Path: ' + path); // replace with mobile-safe file open logic if needed
      }
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateProgress(percent) {
      document.getElementById('bar').style.width = percent + '%';
    }

    function triggerFile() {
      document.getElementById('input').click();
    }

    async function handleFiles(files) {
      log('[*] Starting encryption...');
      const zip = new JSZip();
      const contents = [];
      const signatures = [];

      const encoder = new TextEncoder();
      const cryptoKey = await crypto.subtle.importKey(
        'raw', hexToBytes(keyHex), { name: 'AES-CFB', length: 256 }, false, ['encrypt']
      );

      const fileList = Array.from(files).filter(f => !f.webkitRelativePath.startsWith('texts/'));
      const total = fileList.length;
      let done = 0;

      for (const file of fileList) {
        const path = file.webkitRelativePath;
        const fileBuffer = await file.arrayBuffer();
        const baseName = path.split('/').pop();

        const isExcluded = exclusions.includes(baseName) || path.startsWith('texts/');

        let finalBuffer;
        if (isExcluded) {
          finalBuffer = fileBuffer;
          log(`[+] Excluded: ${path}`, path);
        } else {
          finalBuffer = await crypto.subtle.encrypt(
            { name: 'AES-CFB', iv: hexToBytes(ivHex) },
            cryptoKey,
            fileBuffer
          );
          log(`[+] Encrypted: ${path}`, path);
        }

        zip.file(path, new Uint8Array(finalBuffer));

        const hash = await crypto.subtle.digest('SHA-256', fileBuffer);
        signatures.push({ hash: arrayToBase64(hash), path });
        contents.push({ key: arrayToBase64(hash), path });

        updateProgress(Math.round((++done / total) * 100));
      }

      const contentsJson = JSON.stringify(contents);
      const signaturesJson = JSON.stringify(signatures);

      const encContents = await crypto.subtle.encrypt(
        { name: 'AES-CFB', iv: hexToBytes(ivHex) },
        cryptoKey,
        encoder.encode(contentsJson)
      );

      const encSignatures = await crypto.subtle.encrypt(
        { name: 'AES-CFB', iv: hexToBytes(ivHex) },
        cryptoKey,
        encoder.encode(signaturesJson)
      );

      zip.file('contents.json', new Uint8Array(encContents));
      zip.file('signatures.json', new Uint8Array(encSignatures));

      log('[âœ“] All files processed. Generating .zip...');
      const blob = await zip.generateAsync({ type: 'blob' });

      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'encrypted_pack.zip';
      a.textContent = '[ðŸ’¾] Download Encrypted Pack';
      a.style.display = 'block';
      a.style.marginTop = '15px';
      document.body.appendChild(a);
    }

    function hexToBytes(hex) {
      const bytes = [];
      for (let c = 0; c < hex.length; c += 2)
        bytes.push(parseInt(hex.substr(c, 2), 16));
      return new Uint8Array(bytes);
    }

    function arrayToBase64(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</body>
</html>
