
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fluxis Pack Encrypter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1f1c2c, #928dab);
      color: white;
      text-align: center;
      padding: 30px;
    }
    input[type="file"] {
      margin: 20px;
    }
    #drop-area {
      border: 2px dashed white;
      padding: 30px;
      margin: 20px;
      cursor: pointer;
    }
    progress {
      width: 100%;
      height: 20px;
    }
  </style>
</head>
<body>
  <h1>Fluxis Pack Encrypter</h1>
  <div id="drop-area">Drop your files here</div>
  <progress id="progressBar" value="0" max="100"></progress>
  <script>
    const KEY = "s5s5ejuDru4uchuF2drUFuthaspAbepE";
    const IV = "s5s5ejuDru4uchuF";
    const EXCLUDE_PATHS = ["manifest.json", "pack_icon.png"];
    const EXCLUDE_FOLDER = "texts/";
    const encoder = new TextEncoder();

    async function encryptFile(file) {
      const keyBytes = encoder.encode(KEY);
      const ivBytes = encoder.encode(IV);
      const key = await crypto.subtle.importKey("raw", keyBytes, { name: "AES-CFB" }, false, ["encrypt"]);
      const data = new Uint8Array(await file.arrayBuffer());
      const encrypted = await crypto.subtle.encrypt({ name: "AES-CFB", iv: ivBytes }, key, data);
      return new Uint8Array(encrypted);
    }

    function isExcluded(path) {
      return EXCLUDE_PATHS.includes(path) || path.startsWith(EXCLUDE_FOLDER);
    }

    function generateKey() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let result = "";
      for (let i = 0; i < 32; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
      return result;
    }

    document.getElementById("drop-area").addEventListener("drop", async (event) => {
      event.preventDefault();
      const files = event.dataTransfer.items ? [...event.dataTransfer.items].map(item => item.getAsFile()) : [...event.dataTransfer.files];
      const zip = new JSZip();
      const contents = { version: 1, content: [] };
      const signatures = [];
      const totalFiles = files.length;
      let processed = 0;

      for (const file of files) {
        const path = file.webkitRelativePath || file.name;
        const content = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest("SHA-256", content);
        const hashBase64 = btoa(String.fromCharCode(...new Uint8Array(hashBuffer)));
        signatures.push({ hash: hashBase64, path });

        if (isExcluded(path)) {
          zip.file(path, content);
          contents.content.push({ path });
        } else {
          const encrypted = await encryptFile(new File([content], path));
          const fileKey = generateKey();
          zip.file(path, encrypted);
          contents.content.push({ key: fileKey, path });
        }

        processed++;
        document.getElementById("progressBar").value = (processed / totalFiles) * 100;
      }

      // Add encrypted contents.json and signatures.json
      const contentsBlob = new Blob([JSON.stringify(contents)], { type: "application/json" });
      const encryptedContents = await encryptFile(new File([contentsBlob], "contents.json"));
      zip.file("contents.json", encryptedContents);

      const signaturesBlob = new Blob([JSON.stringify(signatures)], { type: "application/json" });
      const encryptedSignatures = await encryptFile(new File([signaturesBlob], "signatures.json"));
      zip.file("signatures.json", encryptedSignatures);

      // Generate zip
      const blob = await zip.generateAsync({ type: "blob" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "EncryptedPack.zip";
      a.click();
    });

    document.getElementById("drop-area").addEventListener("dragover", e => e.preventDefault());
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
</body>
</html>
