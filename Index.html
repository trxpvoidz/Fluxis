<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fluxis Pack Encryptor</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      background: linear-gradient(to right, #111, #1c1c1c);
      color: #fff;
      font-family: monospace;
      padding: 20px;
      text-align: center;
    }
    #drop-zone {
      border: 2px dashed #555;
      padding: 30px;
      margin: 20px auto;
      width: 80%;
      cursor: pointer;
    }
    #log {
      text-align: left;
      white-space: pre-wrap;
      background: #000;
      padding: 10px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 14px;
    }
    progress {
      width: 100%;
      height: 20px;
    }
  </style>
</head>
<body>
  <h1>Fluxis Pack Encryptor</h1>
  <div id="drop-zone">Drop your pack folder here or click to select</div>
  <input type="file" id="file-input" webkitdirectory directory multiple hidden />
  <progress id="progress" value="0" max="100" hidden></progress>
  <div id="log"></div>
  <script>
    const key = CryptoJS.enc.Utf8.parse("s5s5ejuDru4uchuF2drUFuthaspAbepE");
    const iv = CryptoJS.enc.Utf8.parse("s5s5ejuDru4uchuF");

    function log(msg) {
      const logEl = document.getElementById("log");
      const span = document.createElement("span");
      span.textContent = msg + "\n";
      logEl.appendChild(span);
      span.addEventListener("click", () => alert(msg));
    }

    function encryptCFB(content) {
      const wordArray = CryptoJS.lib.WordArray.create(content);
      const encrypted = CryptoJS.AES.encrypt(wordArray, key, {
        iv: iv,
        mode: CryptoJS.mode.CFB,
        padding: CryptoJS.pad.NoPadding
      });
      return encrypted.ciphertext;
    }

    function sha256(buffer) {
      const wordArray = CryptoJS.lib.WordArray.create(buffer);
      const hash = CryptoJS.SHA256(wordArray);
      return CryptoJS.enc.Base64.stringify(hash);
    }

    function isExcluded(path) {
      return path.endsWith("manifest.json") || path.endsWith("pack_icon.png") || path.includes("/texts/");
    }

    document.getElementById("drop-zone").addEventListener("click", () => {
      document.getElementById("file-input").click();
    });

    document.getElementById("drop-zone").addEventListener("dragover", e => {
      e.preventDefault();
    });

    document.getElementById("drop-zone").addEventListener("drop", e => {
      e.preventDefault();
      handleFiles(e.dataTransfer.files);
    });

    document.getElementById("file-input").addEventListener("change", e => {
      handleFiles(e.target.files);
    });

    async function handleFiles(fileList) {
      const files = Array.from(fileList);
      const zip = new JSZip();
      const contents = [];
      const signatures = [];

      const progress = document.getElementById("progress");
      progress.hidden = false;
      progress.value = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const relativePath = file.webkitRelativePath || file.name;
        log("Processing: " + relativePath);

        const arrayBuffer = await file.arrayBuffer();
        const uint8 = new Uint8Array(arrayBuffer);
        const hash = sha256(uint8);
        signatures.push(`{"hash":"${hash}","path":"${relativePath}"}`);

        if (!isExcluded(relativePath)) {
          const encrypted = encryptCFB(uint8);
          zip.file(relativePath, encrypted.toString(CryptoJS.enc.Base64), { base64: true });
          contents.push({ key: relativePath, path: relativePath });
        } else {
          zip.file(relativePath, uint8);
        }

        progress.value = (i + 1) / files.length * 100;
      }

      // contents.json + signatures.json
      const contentsJSON = JSON.stringify(contents);
      const signaturesJSON = "[" + signatures.join(",") + "]";
      const encContents = encryptCFB(new TextEncoder().encode(contentsJSON));
      const encSignatures = encryptCFB(new TextEncoder().encode(signaturesJSON));

      zip.file("contents.json", encContents.toString(CryptoJS.enc.Base64), { base64: true });
      zip.file("signatures.json", encSignatures.toString(CryptoJS.enc.Base64), { base64: true });

      const blob = await zip.generateAsync({ type: "blob" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "encrypted_pack.zip";
      a.textContent = "Download Encrypted Pack";
      a.style.display = "block";
      a.style.marginTop = "20px";
      document.body.appendChild(a);
      log("âœ… Done. Pack ready.");
      progress.hidden = true;
    }
  </script>
</body>
</html>
