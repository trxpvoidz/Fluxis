<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fluxis Pack Encryptor</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1f1c2c, #928dab);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    #dropzone {
      border: 3px dashed #0ff;
      padding: 40px; width: 90%; max-width: 600px;
      text-align: center; margin-bottom: 20px;
      cursor: pointer; transition: background 0.2s;
    }
    #dropzone:hover { background: rgba(255,255,255,0.1); }
    #progress-container { width: 100%; max-width: 600px; background: rgba(255,255,255,0.2); height: 20px; border-radius: 10px; margin-bottom: 10px; }
    #progress-bar { height: 100%; width: 0%; background: limegreen; transition: width 0.2s ease; }
    #log {
      width: 100%; max-width: 600px;
      height: 200px; background: #111; border: 1px solid #444;
      overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; margin-bottom: 10px;
    }
    #download-btn {
      background: #0ff; color: #000; padding: 10px 20px;
      border: none; cursor: pointer; font-weight: bold; border-radius: 6px;
      display: none;
    }
  </style>
</head>
<body>

<h1>Fluxis Pack Encryptor</h1>
<div id="dropzone">Drop your skin pack folder here (or click)</div>
<div id="progress-container"><div id="progress-bar"></div></div>
<pre id="log">[Fluxis Initialized]</pre>
<button id="download-btn">Download Encrypted ZIP</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
(async () => {
  const keyBytes = new TextEncoder().encode("s5s5ejuDru4uchuF2drUFuthaspAbepE");
  const ivBytes = new TextEncoder().encode("s5s5ejuDru4uchuF");
  const cryptoKey = await crypto.subtle.importKey("raw", keyBytes, { name: "AES-CFB", length: 256 }, false, ["encrypt"]);

  const dropzone = document.getElementById("dropzone");
  const log = document.getElementById("log");
  const progressBar = document.getElementById("progress-bar");
  const downloadBtn = document.getElementById("download-btn");
  let files = [];

  function logMsg(msg) {
    log.textContent += `\n${msg}`;
    log.scrollTop = log.scrollHeight;
  }
  function setProgress(p) {
    progressBar.style.width = `${p}%`;
  }

  dropzone.addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file";
    input.webkitdirectory = true;
    input.multiple = true;
    input.onchange = () => handleFiles(Array.from(input.files));
    input.click();
  });

  dropzone.addEventListener("dragover", e => { e.preventDefault(); });
  dropzone.addEventListener("drop", e => {
    e.preventDefault();
    handleFiles(Array.from(e.dataTransfer.files));
  });

  async function handleFiles(fileList) {
    files = fileList;
    log.textContent = "";
    setProgress(0);
    await processFiles();
  }

  async function processFiles() {
    const zip = new JSZip();
    const contentsArr = [];
    const signaturesArr = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const path = file.webkitRelativePath || file.name;
      const excluded = path === "manifest.json" || path === "pack_icon.png" || path.startsWith("texts/");
      const data = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashBase64 = btoa(String.fromCharCode(...new Uint8Array(hashBuffer)));
      signaturesArr.push({ path, hash: hashBase64 });

      if (excluded) {
        zip.file(path, data);
        contentsArr.push({ path });
        logMsg(`Skipped: ${path}`);
      } else {
        const encBuffer = await crypto.subtle.encrypt({ name: "AES-CFB", iv: ivBytes }, cryptoKey, data);
        zip.file(path, encBuffer);
        const keyStr = generateKey();
        contentsArr.push({ key: keyStr, path });
        logMsg(`Encrypted: ${path}`);
      }

      setProgress(((i + 1) / files.length) * 100);
    }

    const contentsJson = JSON.stringify({ version: 1, content: contentsArr }, null, 2);
    const signaturesJson = JSON.stringify(signaturesArr);

    const encContents = await crypto.subtle.encrypt({ name: "AES-CFB", iv: ivBytes }, cryptoKey, new TextEncoder().encode(contentsJson));
    const encSignatures = await crypto.subtle.encrypt({ name: "AES-CFB", iv: ivBytes }, cryptoKey, new TextEncoder().encode(signaturesJson));

    zip.file("contents.json", encContents);
    zip.file("signatures.json", encSignatures);

    const blob = await zip.generateAsync({ type: "blob" });
    const url = URL.createObjectURL(blob);
    downloadBtn.href = url;
    downloadBtn.download = "encrypted_pack.zip";
    downloadBtn.style.display = "inline-block";
    logMsg("Done â€“ ready to download!");
  }

  function generateKey() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let out = "";
    for (let i = 0; i < 32; i++) out += chars.charAt(Math.floor(Math.random() * chars.length));
    return out;
  }
})();
</script>
</body>
</html>
