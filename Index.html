<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fluxis Pack Encryptor</title>
  <style>
    body {
      background: #0a0a0a;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      font-size: 2em;
      background: linear-gradient(90deg, #6af, #a6f);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 10px #6af;
    }
    #dropzone {
      border: 2px dashed #aaa;
      padding: 40px;
      margin: 20px;
      border-radius: 10px;
      cursor: pointer;
    }
    #manifestPreview {
      margin: 10px auto;
      white-space: pre-wrap;
      max-width: 600px;
      background: #111;
      padding: 10px;
      border-radius: 6px;
      font-size: 0.85em;
    }
    progress {
      width: 80%;
      margin-top: 10px;
    }
    #status {
      margin-top: 8px;
      font-size: 0.9em;
      color: #aaa;
    }
    button {
      margin-top: 12px;
      background: #222;
      color: white;
      border: 1px solid #555;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #333;
    }
    #log {
      max-width: 90%;
      margin: 20px auto;
      text-align: left;
      background: #111;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.85em;
      overflow-x: auto;
    }
    #log div {
      margin: 4px 0;
      cursor: pointer;
    }
    #log div:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Fluxis Pack Encryptor</h1>
  <div id="dropzone">Drop your Minecraft pack folder here<br/>or tap to select on mobile</div>
  <input type="file" id="filePicker" webkitdirectory directory multiple hidden />
  <label><input type="checkbox" id="dontEncrypt">Don't Encrypt (for testing)</label>
  <pre id="manifestPreview"></pre>
  <progress id="progressBar" value="0" max="100"></progress>
  <div id="status">Waiting for files...</div>
  <div id="log"></div>
  <button onclick="startEncryption()">Start Encryption</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    const key = new TextEncoder().encode('s5s5ejuDru4uchuF2drUFuthaspAbepE');
    const iv = new TextEncoder().encode('s5s5ejuDru4uchuF');
    const dropzone = document.getElementById('dropzone');
    const filePicker = document.getElementById('filePicker');
    const progressBar = document.getElementById('progressBar');
    const status = document.getElementById('status');
    const logBox = document.getElementById('log');
    let files = [];

    dropzone.onclick = () => filePicker.click();
    filePicker.onchange = (e) => {
      files = [...e.target.files];
      previewManifest(files);
    };
    dropzone.ondragover = e => { e.preventDefault(); dropzone.style.borderColor = "#6af"; };
    dropzone.ondragleave = () => dropzone.style.borderColor = "#aaa";
    dropzone.ondrop = (e) => {
      e.preventDefault();
      dropzone.style.borderColor = "#aaa";
      files = [...e.dataTransfer.files];
      previewManifest(files);
    };

    function log(msg, fileBlob) {
      const div = document.createElement('div');
      div.textContent = msg;
      if (fileBlob) {
        div.onclick = () => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(fileBlob);
          a.download = msg.split(":")[1]?.trim() || "file";
          a.click();
        };
      }
      logBox.appendChild(div);
    }

    function previewManifest(fileList) {
      const manifestFile = fileList.find(f => f.webkitRelativePath.endsWith('manifest.json'));
      if (!manifestFile) return document.getElementById('manifestPreview').textContent = '❌ No manifest.json found.';
      manifestFile.text().then(txt => {
        document.getElementById('manifestPreview').textContent = txt;
      });
    }

    async function startEncryption() {
      if (!files.length) return alert("Drop or select a pack folder first.");
      const dontEncrypt = document.getElementById('dontEncrypt').checked;
      const zip = new JSZip();
      const contentsList = [];
      let processed = 0;

      for (const file of files) {
        const relPath = file.webkitRelativePath.split('/').slice(1).join('/');

        if (
          relPath === 'manifest.json' ||
          relPath === 'pack_icon.png' ||
          relPath.startsWith('texts/')
        ) {
          zip.file(relPath, file);
          log("Excluded: " + relPath);
          continue;
        }

        const buffer = await file.arrayBuffer();
        let encryptedData = new Uint8Array(buffer);

        if (!dontEncrypt) {
          encryptedData = await aesEncryptCFB(encryptedData, key, iv);
        }

        zip.file(relPath, encryptedData);
        const hashBuffer = await crypto.subtle.digest('SHA-256', encryptedData);
        const hash = btoa(String.fromCharCode(...new Uint8Array(hashBuffer)));
        contentsList.push({ path: relPath, hash });

        processed++;
        progressBar.value = (processed / files.length) * 100;
        status.textContent = "Encrypting: " + relPath;
        log("Encrypted: " + relPath);
      }

      // Generate contents.json and signatures.json
      const contentsBlob = new Blob([JSON.stringify({ key: "files", path: contentsList }, null, 2)], { type: 'application/json' });
      const sigBlob = new Blob([JSON.stringify(contentsList.map(e => ({ path: e.path, hash: e.hash })), null, 2)], { type: 'application/json' });

      const encryptedContents = await aesEncryptCFB(new Uint8Array(await contentsBlob.arrayBuffer()), key, iv);
      const encryptedSignatures = await aesEncryptCFB(new Uint8Array(await sigBlob.arrayBuffer()), key, iv);

      zip.file('contents.json', encryptedContents);
      zip.file('signatures.json', encryptedSignatures);

      const finalBlob = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(finalBlob);
      a.download = "encrypted_pack.zip";
      a.click();
      log("✅ Download: encrypted_pack.zip", finalBlob);
      status.textContent = "✅ Finished!";
    }

    async function aesEncryptCFB(data, keyBytes, ivBytes) {
      const cryptoKey = await crypto.subtle.importKey('raw', keyBytes, { name: 'AES-CFB', length: 256 }, false, ['encrypt']);
      const encrypted = await crypto.subtle.encrypt({ name: 'AES-CFB', iv: ivBytes }, cryptoKey, data);
      return new Uint8Array(encrypted);
    }
  </script>
</body>
</html>
